<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Financial Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">Financial Analyzer</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('dashboard') }}">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('upload') }}">Upload Statement</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('generate_report') }}">Generate Report</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Summary Cards -->
        <div class="row mb-4" id="summary-cards">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Transactions</h5>
                        <h2 class="card-text" id="total-transactions">--</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Credit
                        <h2 class="card-text" id="total-credit">--</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Expenses</h5>
                        <h2 class="card-text" id="total-debit">--</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Net Cash Flow</h5>
                        <h2 class="card-text" id="net-cashflow">--</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Data Alert -->
        <div class="row mb-4" id="no-data-alert" style="display: none;">
            <div class="col-12">
                <div class="alert alert-warning">
                    <h4><i class="bi bi-exclamation-triangle"></i> No transaction data available</h4>
                    <p>Please upload your bank statement to see insights and analysis.</p>
                    <a href="{{ url_for('upload') }}" class="btn btn-primary">Upload Bank Statement</a>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Content -->
        <div class="row" id="dashboard-content">
            <!-- Category Breakdown -->
            <div class="col-md-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Spending by Category</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="category-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Trend -->
            <div class="col-md-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Monthly Spending Trend</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthly-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Daily Spending Heatmap -->
            <div class="col-md-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Daily Spending Heatmap</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="heatmap-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Projection -->
            <div class="col-md-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Monthly Budget Projection</h5>
                    </div>
                    <div class="card-body">
                        <div id="projection-container">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Current</th>
                                            <th>Projected</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="projection-table">
                                        <!-- Projection data will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anomalies -->
            <div class="col-md-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Unusual Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Category</th>
                                    </tr>
                                </thead>
                                <tbody id="anomalies-table">
                                    <!-- Anomalies will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recurring Transactions -->
            <div class="col-md-6 mb-4">
                <div class="card shadow h-100">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Recurring Transactions</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Category</th>
                                        <th>Last Date</th>
                                    </tr>
                                </thead>
                                <tbody id="recurring-table">
                                    <!-- Recurring transactions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2
            }).format(amount);
        }

        // Colors for categories
        const categoryColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
            '#FF9F40', '#8AC249', '#EA5545', '#F46A9B', '#EF9B20',
            '#EDBF33', '#87BC45', '#27AEEF', '#B33DC6'
        ];

        // Load dashboard data
        document.addEventListener('DOMContentLoaded', function() {
            // Load basic stats
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.total_transactions === 0) {
                        document.getElementById('no-data-alert').style.display = 'block';
                        document.getElementById('dashboard-content').style.display = 'none';
                    } else {
                        document.getElementById('no-data-alert').style.display = 'none';
                        document.getElementById('dashboard-content').style.display = 'flex';
                        
                        document.getElementById('total-transactions').textContent = data.total_transactions;
                        document.getElementById('total-credit').textContent = formatCurrency(data.total_credit);
                        document.getElementById('total-debit').textContent = formatCurrency(data.total_debit);
                        document.getElementById('net-cashflow').textContent = formatCurrency(data.net_cashflow);
                    }
                })
                .catch(error => console.error('Error loading stats:', error));

            // Load category breakdown
            fetch('/api/categories')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const labels = data.map(item => item.category.charAt(0).toUpperCase() + item.category.slice(1));
                        const values = data.map(item => item.amount);
                        
                        const ctx = document.getElementById('category-chart').getContext('2d');
                        new Chart(ctx, {
                            type: 'pie',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: values,
                                    backgroundColor: categoryColors.slice(0, labels.length),
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        position: 'right',
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                label += formatCurrency(context.raw);
                                                return label;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading categories:', error));

            // Load monthly data
            fetch('/api/monthly')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const labels = data.map(item => item.month);
                        const values = data.map(item => item.total_debit);
                        
                        const ctx = document.getElementById('monthly-chart').getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Monthly Spending',
                                    data: values,
                                    borderColor: '#36A2EB',
                                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            callback: function(value) {
                                                return formatCurrency(value);
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                label += formatCurrency(context.raw);
                                                return label;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading monthly data:', error));

            // Load heatmap data
            fetch('/api/heatmap')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        const dates = data.map(item => item.date);
                        const amounts = data.map(item => item.amount);
                        
                        // Group by month for better visualization
                        const monthlyData = {};
                        
                        for (let i = 0; i < dates.length; i++) {
                            const date = dates[i];
                            const month = date.substring(0, 7); // YYYY-MM
                            if (!monthlyData[month]) {
                                monthlyData[month] = {
                                    dates: [],
                                    amounts: []
                                };
                            }
                            
                            monthlyData[month].dates.push(date);
                            monthlyData[month].amounts.push(amounts[i]);
                        }
                        
                        const months = Object.keys(monthlyData).sort();
                        const datasets = months.map((month, index) => {
                            return {
                                label: month,
                                data: monthlyData[month].dates.map((date, i) => ({
                                    x: date,
                                    y: monthlyData[month].amounts[i]
                                })),
                                backgroundColor: categoryColors[index % categoryColors.length],
                                borderColor: 'rgba(0, 0, 0, 0.1)',
                                borderWidth: 1
                            };
                        });
                        
                        const ctx = document.getElementById('heatmap-chart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    x: {
                                        type: 'time',
                                        time: {
                                            unit: 'day',
                                            tooltipFormat: 'MMM D, YYYY'
                                        },
                                        title: {
                                            display: true,
                                            text: 'Date'
                                        }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Spending Amount'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return formatCurrency(value);
                                            }
                                        }
                                    }
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                let label = context.dataset.label || '';
                                                if (label) {
                                                    label += ': ';
                                                }
                                                label += formatCurrency(context.raw.y);
                                                return label;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading heatmap data:', error));

            // Load projections data
            fetch('/api/projections')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('projection-table');
                    tbody.innerHTML = ''; // Clear existing content
                    
                    // Skip the 'total' entry, will add it at the end
                    const totalData = data.total;
                    delete data.total;
                    
                    // Add rows for each category
                    for (const [category, values] of Object.entries(data)) {
                        const tr = document.createElement('tr');
                        
                        // Category name
                        const tdCategory = document.createElement('td');
                        tdCategory.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                        tr.appendChild(tdCategory);
                        
                        // Current spent
                        const tdCurrent = document.createElement('td');
                        tdCurrent.textContent = formatCurrency(values.current_spent);
                        tr.appendChild(tdCurrent);
                        
                        // Projected amount
                        const tdProjected = document.createElement('td');
                        tdProjected.textContent = formatCurrency(values.projected_amount);
                        tr.appendChild(tdProjected);
                        
                        // Status
                        const tdStatus = document.createElement('td');
                        if (values.possible_overshoot) {
                            tdStatus.innerHTML = '<span class="badge bg-danger">Overshoot Risk</span>';
                        } else {
                            tdStatus.innerHTML = '<span class="badge bg-success">On Track</span>';
                        }
                        tr.appendChild(tdStatus);
                        
                        tbody.appendChild(tr);
                    }
                    
                    // Add total row if it exists
                    if (totalData) {
                        const trTotal = document.createElement('tr');
                        trTotal.className = 'table-active fw-bold';
                        
                        // Category name
                        const tdCategory = document.createElement('td');
                        tdCategory.textContent = 'TOTAL';
                        trTotal.appendChild(tdCategory);
                        
                        // Current spent
                        const tdCurrent = document.createElement('td');
                        tdCurrent.textContent = formatCurrency(totalData.current_spent);
                        trTotal.appendChild(tdCurrent);
                        
                        // Projected amount
                        const tdProjected = document.createElement('td');
                        tdProjected.textContent = formatCurrency(totalData.projected_amount);
                        trTotal.appendChild(tdProjected);
                        
                        // Status
                        const tdStatus = document.createElement('td');
                        if (totalData.possible_overshoot) {
                            tdStatus.innerHTML = '<span class="badge bg-danger">Overshoot Risk</span>';
                        } else {
                            tdStatus.innerHTML = '<span class="badge bg-success">On Track</span>';
                        }
                        trTotal.appendChild(tdStatus);
                        
                        tbody.appendChild(trTotal);
                    }
                })
                .catch(error => console.error('Error loading projections:', error));

            // Load anomalies
            fetch('/api/anomalies')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('anomalies-table');
                    tbody.innerHTML = ''; // Clear existing content
                    
                    if (data.length === 0) {
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 4;
                        td.textContent = 'No unusual transactions detected';
                        td.className = 'text-center';
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                        return;
                    }
                    
                    data.forEach(anomaly => {
                        const tr = document.createElement('tr');
                        
                        // Date
                        const tdDate = document.createElement('td');
                        tdDate.textContent = new Date(anomaly.date).toLocaleDateString();
                        tr.appendChild(tdDate);
                        
                        // Description
                        const tdDesc = document.createElement('td');
                        tdDesc.textContent = anomaly.description.length > 30 ? 
                            anomaly.description.substring(0, 30) + '...' : 
                            anomaly.description;
                        tdDesc.title = anomaly.description; // Show full text on hover
                        tr.appendChild(tdDesc);
                        
                        // Amount
                        const tdAmount = document.createElement('td');
                        tdAmount.textContent = formatCurrency(anomaly.amount);
                        tr.appendChild(tdAmount);
                        
                        // Category
                        const tdCategory = document.createElement('td');
                        tdCategory.textContent = anomaly.category.charAt(0).toUpperCase() + anomaly.category.slice(1);
                        tr.appendChild(tdCategory);
                        
                        tbody.appendChild(tr);
                    });
                })
                .catch(error => console.error('Error loading anomalies:', error));

            // Load recurring transactions
            fetch('/api/recurring')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('recurring-table');
                    tbody.innerHTML = ''; // Clear existing content
                    
                    if (data.length === 0) {
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 4;
                        td.textContent = 'No recurring transactions detected';
                        td.className = 'text-center';
                        tr.appendChild(td);
                        tbody.appendChild(tr);
                        return;
                    }
                    
                    // Group by description to avoid duplicates
                    const groupedData = {};
                    data.forEach(item => {
                        const key = `${item.description}-${item.amount}`;
                        if (!groupedData[key] || new Date(item.date) > new Date(groupedData[key].date)) {
                            groupedData[key] = item;
                        }
                    });
                    
                    Object.values(groupedData).forEach(transaction => {
                        const tr = document.createElement('tr');
                        
                        // Description
                        const tdDesc = document.createElement('td');
                        tdDesc.textContent = transaction.description.length > 30 ? 
                            transaction.description.substring(0, 30) + '...' : 
                            transaction.description;
                        tdDesc.title = transaction.description; // Show full text on hover
                        tr.appendChild(tdDesc);
                        
                        // Amount
                        const tdAmount = document.createElement('td');
                        tdAmount.textContent = formatCurrency(transaction.amount);
                        tr.appendChild(tdAmount);
                        
                        // Category
                        const tdCategory = document.createElement('td');
                        tdCategory.textContent = transaction.category.charAt(0).toUpperCase() + transaction.category.slice(1);
                        tr.appendChild(tdCategory);
                        
                        // Last Date
                        const tdDate = document.createElement('td');
                        tdDate.textContent = new Date(transaction.date).toLocaleDateString();
                        tr.appendChild(tdDate);
                        
                        tbody.appendChild(tr);
                    });
                })
                .catch(error => console.error('Error loading recurring transactions:', error));
        });
    </script>
</body>
</html>